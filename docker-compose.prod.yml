version: '3.8'

# =============================================================================
# AMAZON-STYLE SCALED ARCHITECTURE
# =============================================================================
# - Stateless services with horizontal scaling
# - Multiple replicas behind load balancer
# - Kafka partitioning for high throughput
# - Redis for distributed caching
# - All state in Postgres/Redis/Kafka
# =============================================================================

services:
  # ===========================================================================
  # INFRASTRUCTURE
  # ===========================================================================
  
  postgres-primary:
    image: postgres:15-alpine
    container_name: ecommerce-postgres-primary
    environment:
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce123
      POSTGRES_DB: ecommerce
    ports:
      - "5432:5432"
    volumes:
      - postgres_primary_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=256MB
      -c effective_cache_size=768MB
      -c work_mem=16MB
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ecommerce"]
      interval: 5s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 1G

  postgres-replica:
    image: postgres:15-alpine
    container_name: ecommerce-postgres-replica
    environment:
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce123
      POSTGRES_DB: ecommerce
    volumes:
      - postgres_replica_data:/var/lib/postgresql/data
    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=256MB
    depends_on:
      postgres-primary:
        condition: service_healthy

  redis:
    image: redis:7-alpine
    container_name: ecommerce-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # KAFKA CLUSTER (3 brokers for production)
  # ===========================================================================
  
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: ecommerce-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"

  kafka-1:
    image: confluentinc/cp-kafka:7.5.0
    container_name: ecommerce-kafka-1
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-1:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_NUM_PARTITIONS: 6
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_MIN_INSYNC_REPLICAS: 2
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"

  kafka-2:
    image: confluentinc/cp-kafka:7.5.0
    container_name: ecommerce-kafka-2
    depends_on:
      - zookeeper
    ports:
      - "9093:9092"
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-2:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_NUM_PARTITIONS: 6

  kafka-3:
    image: confluentinc/cp-kafka:7.5.0
    container_name: ecommerce-kafka-3
    depends_on:
      - zookeeper
    ports:
      - "9094:9092"
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-3:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_NUM_PARTITIONS: 6

  # Kafka topic initialization
  kafka-init:
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      - kafka-1
      - kafka-2
      - kafka-3
    command: >
      bash -c "
        echo 'Waiting for Kafka...' &&
        sleep 30 &&
        kafka-topics --create --if-not-exists --topic orders --partitions 6 --replication-factor 3 --bootstrap-server kafka-1:9092 &&
        kafka-topics --create --if-not-exists --topic inventory --partitions 6 --replication-factor 3 --bootstrap-server kafka-1:9092 &&
        kafka-topics --create --if-not-exists --topic payments --partitions 6 --replication-factor 3 --bootstrap-server kafka-1:9092 &&
        kafka-topics --create --if-not-exists --topic notifications --partitions 3 --replication-factor 3 --bootstrap-server kafka-1:9092 &&
        kafka-topics --create --if-not-exists --topic dead-letter --partitions 3 --replication-factor 3 --bootstrap-server kafka-1:9092 &&
        echo 'Topics created successfully'
      "

  # ===========================================================================
  # STATELESS APPLICATION SERVICES (Multiple Replicas)
  # ===========================================================================

  # Order Service - 3 replicas
  order-service-1:
    build:
      context: ./services/order-service
      dockerfile: Dockerfile
    container_name: order-service-1
    environment:
      INSTANCE_ID: order-service-1
      DATABASE_URL: postgresql+asyncpg://ecommerce:ecommerce123@postgres-primary:5432/ecommerce
      DATABASE_READ_URL: postgresql+asyncpg://ecommerce:ecommerce123@postgres-replica:5432/ecommerce
      REDIS_URL: redis://redis:6379/1
      KAFKA_BOOTSTRAP_SERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
      KAFKA_CONSUMER_GROUP: order-service-group
      SERVICE_NAME: order-service
    depends_on:
      - postgres-primary
      - redis
      - kafka-init
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  order-service-2:
    build:
      context: ./services/order-service
      dockerfile: Dockerfile
    container_name: order-service-2
    environment:
      INSTANCE_ID: order-service-2
      DATABASE_URL: postgresql+asyncpg://ecommerce:ecommerce123@postgres-primary:5432/ecommerce
      DATABASE_READ_URL: postgresql+asyncpg://ecommerce:ecommerce123@postgres-replica:5432/ecommerce
      REDIS_URL: redis://redis:6379/1
      KAFKA_BOOTSTRAP_SERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
      KAFKA_CONSUMER_GROUP: order-service-group
      SERVICE_NAME: order-service
    depends_on:
      - postgres-primary
      - redis
      - kafka-init

  order-service-3:
    build:
      context: ./services/order-service
      dockerfile: Dockerfile
    container_name: order-service-3
    environment:
      INSTANCE_ID: order-service-3
      DATABASE_URL: postgresql+asyncpg://ecommerce:ecommerce123@postgres-primary:5432/ecommerce
      DATABASE_READ_URL: postgresql+asyncpg://ecommerce:ecommerce123@postgres-replica:5432/ecommerce
      REDIS_URL: redis://redis:6379/1
      KAFKA_BOOTSTRAP_SERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
      KAFKA_CONSUMER_GROUP: order-service-group
      SERVICE_NAME: order-service
    depends_on:
      - postgres-primary
      - redis
      - kafka-init

  # Inventory Service - 3 replicas
  inventory-service-1:
    build:
      context: ./services/inventory-service
      dockerfile: Dockerfile
    container_name: inventory-service-1
    environment:
      INSTANCE_ID: inventory-service-1
      DATABASE_URL: postgresql+asyncpg://ecommerce:ecommerce123@postgres-primary:5432/ecommerce
      REDIS_URL: redis://redis:6379/2
      KAFKA_BOOTSTRAP_SERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
      KAFKA_CONSUMER_GROUP: inventory-service-group
      SERVICE_NAME: inventory-service
    depends_on:
      - postgres-primary
      - redis
      - kafka-init

  inventory-service-2:
    build:
      context: ./services/inventory-service
      dockerfile: Dockerfile
    container_name: inventory-service-2
    environment:
      INSTANCE_ID: inventory-service-2
      DATABASE_URL: postgresql+asyncpg://ecommerce:ecommerce123@postgres-primary:5432/ecommerce
      REDIS_URL: redis://redis:6379/2
      KAFKA_BOOTSTRAP_SERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
      KAFKA_CONSUMER_GROUP: inventory-service-group
      SERVICE_NAME: inventory-service
    depends_on:
      - postgres-primary
      - redis
      - kafka-init

  inventory-service-3:
    build:
      context: ./services/inventory-service
      dockerfile: Dockerfile
    container_name: inventory-service-3
    environment:
      INSTANCE_ID: inventory-service-3
      DATABASE_URL: postgresql+asyncpg://ecommerce:ecommerce123@postgres-primary:5432/ecommerce
      REDIS_URL: redis://redis:6379/2
      KAFKA_BOOTSTRAP_SERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
      KAFKA_CONSUMER_GROUP: inventory-service-group
      SERVICE_NAME: inventory-service
    depends_on:
      - postgres-primary
      - redis
      - kafka-init

  # Payment Service - 3 replicas
  payment-service-1:
    build:
      context: ./services/payment-service
      dockerfile: Dockerfile
    container_name: payment-service-1
    environment:
      INSTANCE_ID: payment-service-1
      DATABASE_URL: postgresql+asyncpg://ecommerce:ecommerce123@postgres-primary:5432/ecommerce
      REDIS_URL: redis://redis:6379/3
      KAFKA_BOOTSTRAP_SERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
      KAFKA_CONSUMER_GROUP: payment-service-group
      SERVICE_NAME: payment-service
    depends_on:
      - postgres-primary
      - redis
      - kafka-init

  payment-service-2:
    build:
      context: ./services/payment-service
      dockerfile: Dockerfile
    container_name: payment-service-2
    environment:
      INSTANCE_ID: payment-service-2
      DATABASE_URL: postgresql+asyncpg://ecommerce:ecommerce123@postgres-primary:5432/ecommerce
      REDIS_URL: redis://redis:6379/3
      KAFKA_BOOTSTRAP_SERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
      KAFKA_CONSUMER_GROUP: payment-service-group
      SERVICE_NAME: payment-service
    depends_on:
      - postgres-primary
      - redis
      - kafka-init

  payment-service-3:
    build:
      context: ./services/payment-service
      dockerfile: Dockerfile
    container_name: payment-service-3
    environment:
      INSTANCE_ID: payment-service-3
      DATABASE_URL: postgresql+asyncpg://ecommerce:ecommerce123@postgres-primary:5432/ecommerce
      REDIS_URL: redis://redis:6379/3
      KAFKA_BOOTSTRAP_SERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
      KAFKA_CONSUMER_GROUP: payment-service-group
      SERVICE_NAME: payment-service
    depends_on:
      - postgres-primary
      - redis
      - kafka-init

  # User Service - 2 replicas
  user-service-1:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: user-service-1
    environment:
      INSTANCE_ID: user-service-1
      DATABASE_URL: postgresql+asyncpg://ecommerce:ecommerce123@postgres-primary:5432/ecommerce
      REDIS_URL: redis://redis:6379/0
      KAFKA_BOOTSTRAP_SERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
      SERVICE_NAME: user-service
    depends_on:
      - postgres-primary
      - redis

  user-service-2:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: user-service-2
    environment:
      INSTANCE_ID: user-service-2
      DATABASE_URL: postgresql+asyncpg://ecommerce:ecommerce123@postgres-primary:5432/ecommerce
      REDIS_URL: redis://redis:6379/0
      KAFKA_BOOTSTRAP_SERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
      SERVICE_NAME: user-service
    depends_on:
      - postgres-primary
      - redis

  # ===========================================================================
  # API GATEWAY / LOAD BALANCER
  # ===========================================================================
  
  api-gateway:
    image: nginx:alpine
    container_name: ecommerce-gateway
    ports:
      - "8000:80"
    volumes:
      - ./gateway/nginx.prod.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - order-service-1
      - order-service-2
      - order-service-3
      - inventory-service-1
      - inventory-service-2
      - inventory-service-3
      - payment-service-1
      - payment-service-2
      - payment-service-3
      - user-service-1
      - user-service-2

  # ===========================================================================
  # MONITORING
  # ===========================================================================
  
  prometheus:
    image: prom/prometheus:latest
    container_name: ecommerce-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'

  grafana:
    image: grafana/grafana:latest
    container_name: ecommerce-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
    depends_on:
      - prometheus

volumes:
  postgres_primary_data:
  postgres_replica_data:
  redis_data:
  prometheus_data:
  grafana_data:
